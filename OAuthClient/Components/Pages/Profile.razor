@page "/profile"
@using OAuthClient.Models
@using OAuthClient.Services
@inject ITokenStore TokenStore
@inject IOAuthFlowService OAuthFlow
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>My Profile — Demo App</PageTitle>

<div class="row justify-content-center">
    <div class="col-lg-7">

        <div class="mb-4">
            <h4 class="fw-bold">My Profile</h4>
            <p class="text-muted mb-0">Information returned from the OAuth Provider's /userinfo endpoint.</p>
        </div>

        @if (_loading)
        {
            <div class="card border-0 shadow-sm p-5 text-center">
                <div class="spinner-border text-primary mx-auto mb-3"></div>
                <p class="text-muted">Fetching your profile from the provider…</p>
            </div>
        }
        else if (_error != null)
        {
            <div class="alert alert-danger">
                <strong>Could not load profile:</strong> @_error
                <p class="mb-0 mt-2 small">Your session may have expired. <a href="/Account/Login">Sign in again</a></p>
            </div>
        }
        else if (_profile != null)
        {
            <!-- Avatar + name -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center gap-4">
                        <div class="rounded-circle d-flex align-items-center justify-content-center fw-bold text-white flex-shrink-0"
                             style="width:72px;height:72px;font-size:28px;background:linear-gradient(135deg,#6366f1,#8b5cf6);">
                            @(_profile.Name?.Substring(0, 1).ToUpper() ?? "?")
                        </div>
                        <div>
                            <h4 class="mb-1 fw-bold">@_profile.Name</h4>
                            <p class="mb-1 text-muted">@_profile.Email</p>
                            @if (_profile.EmailVerified)
                            {
                                <span class="badge bg-success">✓ Email verified</span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark">Email not verified</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Claims table -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0 fw-semibold">Profile Claims</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="px-4" style="width:35%">Claim</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="px-4"><code>sub</code></td>
                                <td class="text-muted font-monospace small">@_profile.Sub</td>
                            </tr>
                            <tr>
                                <td class="px-4"><code>email</code></td>
                                <td>@_profile.Email</td>
                            </tr>
                            <tr>
                                <td class="px-4"><code>email_verified</code></td>
                                <td>@_profile.EmailVerified.ToString().ToLower()</td>
                            </tr>
                            <tr>
                                <td class="px-4"><code>given_name</code></td>
                                <td>@(_profile.GivenName ?? "—")</td>
                            </tr>
                            <tr>
                                <td class="px-4"><code>family_name</code></td>
                                <td>@(_profile.FamilyName ?? "—")</td>
                            </tr>
                            <tr>
                                <td class="px-4"><code>name</code></td>
                                <td>@(_profile.Name ?? "—")</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Token info -->
            @if (_tokenEntry != null)
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h6 class="mb-0 fw-semibold">Active Session</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-sm-6">
                                <label class="text-muted small fw-semibold d-block">ACCESS TOKEN</label>
                                <div class="bg-light rounded p-2 font-monospace small text-break"
                                     style="font-size:11px;max-height:60px;overflow:hidden;">
                                    @_tokenEntry.AccessToken[..Math.Min(60, _tokenEntry.AccessToken.Length)]…
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <label class="text-muted small fw-semibold d-block">EXPIRES AT</label>
                                <div class="mt-1">
                                    <span class="@(_tokenEntry.IsExpired ? "text-danger" : "text-success") fw-medium">
                                        @_tokenEntry.ExpiresAt.ToString("MMM d, yyyy HH:mm:ss") UTC
                                    </span>
                                    @if (_tokenEntry.IsExpired)
                                    {
                                        <span class="badge bg-danger ms-2">Expired</span>
                                    }
                                    else
                                    {
                                        var left = _tokenEntry.ExpiresAt - DateTime.UtcNow;
                                        <span class="badge bg-success ms-2">
                                            @((int)left.TotalMinutes)m @left.Seconds%60s left
                                        </span>
                                    }
                                </div>
                                @if (_tokenEntry.RefreshToken != null)
                                {
                                    <div class="mt-2">
                                        <span class="badge bg-info text-dark">Refresh token available</span>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary" @onclick="RefreshToken">
                                ↺ Refresh Token Now
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    [CascadingParameter] private Task<AuthenticationState>? AuthState { get; set; }

    private UserProfile? _profile;
    private TokenEntry? _tokenEntry;
    private bool _loading = true;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        try
        {
            var auth = await AuthState!;
            var sessionId = auth.User.FindFirst("session_id")?.Value;
            if (string.IsNullOrEmpty(sessionId)) { _error = "No session found."; return; }

            _tokenEntry = TokenStore.Get(sessionId);
            if (_tokenEntry == null) { _error = "Session expired. Please sign in again."; return; }

            _profile = await OAuthFlow.GetUserInfoAsync(_tokenEntry.AccessToken);
            if (_profile == null) _error = "Could not fetch profile from provider.";
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task RefreshToken()
    {
        var auth = await AuthState!;
        var sessionId = auth.User.FindFirst("session_id")?.Value;
        if (string.IsNullOrEmpty(sessionId) || _tokenEntry?.RefreshToken == null) return;

        try
        {
            var newTokens = await OAuthFlow.RefreshTokenAsync(_tokenEntry.RefreshToken);
            if (string.IsNullOrEmpty(newTokens.Error) && !string.IsNullOrEmpty(newTokens.AccessToken))
            {
                var expiresAt = DateTime.UtcNow.AddSeconds(newTokens.ExpiresIn > 0 ? newTokens.ExpiresIn : 3600);
                TokenStore.Save(sessionId, newTokens.AccessToken, newTokens.RefreshToken, expiresAt);
                _tokenEntry = TokenStore.Get(sessionId);
                _profile = await OAuthFlow.GetUserInfoAsync(newTokens.AccessToken);
            }
            else
            {
                _error = newTokens.ErrorDescription ?? newTokens.Error ?? "Refresh failed";
            }
        }
        catch (Exception ex)
        {
            _error = $"Refresh error: {ex.Message}";
        }
    }
}
