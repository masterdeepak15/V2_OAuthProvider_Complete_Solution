@page "/dashboard"
@using OAuthClient.Services
@inject ITokenStore TokenStore
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Dashboard â€” Demo App</PageTitle>

<div class="mb-4">
    <h4 class="fw-bold">Dashboard</h4>
    <p class="text-muted mb-0">Your protected area. Only accessible when signed in.</p>
</div>

<AuthorizeView>
    <Authorized>
        <div class="row g-4">

            <!-- Welcome card -->
            <div class="col-12">
                <div class="card border-0 shadow-sm"
                     style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center gap-3">
                            <div class="rounded-circle bg-white d-flex align-items-center justify-content-center fw-bold flex-shrink-0"
                                 style="width:56px;height:56px;font-size:22px;color:#6366f1;">
                                @(context.User.Identity?.Name?.Substring(0, 1).ToUpper() ?? "?")
                            </div>
                            <div>
                                <h4 class="mb-1 fw-bold">Hello, @context.User.Identity?.Name! ðŸ‘‹</h4>
                                <p class="mb-0 opacity-75">You're signed in via OAuth Provider. Your session is active.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Claims from cookie -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h6 class="mb-0 fw-semibold">
                            Claims in Cookie Session
                        </h6>
                        <small class="text-muted">Set during the OAuth callback</small>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="px-3">Type</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var claim in context.User.Claims)
                                    {
                                        var shortType = claim.Type.Contains('/')
                                            ? claim.Type.Split('/').Last()
                                            : claim.Type;
                                        <tr>
                                            <td class="px-3">
                                                <code class="small">@shortType</code>
                                            </td>
                                            <td class="small text-break" style="max-width:200px;">
                                                @(claim.Value.Length > 40
                                                    ? claim.Value[..40] + "â€¦"
                                                    : claim.Value)
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Token status -->
            <div class="col-lg-6">
                @{
                    var sessionId = context.User.FindFirst("session_id")?.Value;
                    var entry = string.IsNullOrEmpty(sessionId) ? null : TokenStore.Get(sessionId);
                }
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3">
                        <h6 class="mb-0 fw-semibold">Server-Side Token Status</h6>
                        <small class="text-muted">Tokens are never stored in the browser</small>
                    </div>
                    <div class="card-body">
                        @if (entry == null)
                        {
                            <div class="alert alert-warning mb-0">
                                No token entry found in server cache. Session may have been lost on server restart.
                                <a href="/Account/Login" class="alert-link">Sign in again</a>
                            </div>
                        }
                        else
                        {
                            <dl class="row mb-3">
                                <dt class="col-5 text-muted small">Status</dt>
                                <dd class="col-7">
                                    @if (entry.IsExpired)
                                    {
                                        <span class="badge bg-danger">Expired</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                </dd>

                                <dt class="col-5 text-muted small">Expires</dt>
                                <dd class="col-7 small">@entry.ExpiresAt.ToString("HH:mm:ss") UTC</dd>

                                <dt class="col-5 text-muted small">Time Left</dt>
                                <dd class="col-7 small">
                                    @{
                                        var left = entry.ExpiresAt - DateTime.UtcNow;
                                        if (left.TotalSeconds > 0)
                                        {
                                            @($"{(int)left.TotalMinutes}m {left.Seconds % 60}s")
                                        }
                                        else
                                        {
                                            <span class="text-danger">Expired</span>
                                        }
                                    }
                                </dd>

                                <dt class="col-5 text-muted small">Refresh Token</dt>
                                <dd class="col-7">
                                    @if (entry.RefreshToken != null)
                                    {
                                        <span class="badge bg-info text-dark">Available</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">None</span>
                                    }
                                </dd>

                                <dt class="col-5 text-muted small">Access Token</dt>
                                <dd class="col-7">
                                    <code class="small" style="word-break:break-all;">
                                        @entry.AccessToken[..Math.Min(30, entry.AccessToken.Length)]â€¦
                                    </code>
                                </dd>
                            </dl>

                            <a href="/profile" class="btn btn-sm btn-outline-primary">View Full Profile â†’</a>
                        }
                    </div>
                </div>
            </div>

            <!-- OAuth flow explanation -->
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h6 class="mb-0 fw-semibold">How the Flow Worked</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-0">
                            @{
                                var steps = new[]
                                {
                                    ("1", "#6366f1", "You clicked Sign In",
                                        "The app generated a PKCE code_verifier and code_challenge (SHA-256), stored them server-side, then redirected you to /authorize on the OAuth Provider."),
                                    ("2", "#8b5cf6", "You authenticated",
                                        "The OAuth Provider showed its login page. After you entered your credentials, it generated an authorization code and redirected back to /auth/callback."),
                                    ("3", "#06b6d4", "Code exchanged",
                                        "This app POSTed the code + code_verifier to /token. The provider verified the PKCE challenge and returned an access_token and refresh_token."),
                                    ("4", "#22c55e", "Session created",
                                        "The app called /userinfo with the access token, built a ClaimsPrincipal, stored the tokens server-side, and issued a secure HttpOnly cookie."),
                                };
                            }
                            @foreach (var (num, color, title, desc) in steps)
                            {
                                <div class="col-md-3 px-3 @(num != "1" ? "border-start" : "")">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <div class="rounded-circle text-white d-flex align-items-center justify-content-center fw-bold flex-shrink-0"
                                             style="width:28px;height:28px;font-size:12px;background:@color;">
                                            @num
                                        </div>
                                        <span class="fw-semibold small">@title</span>
                                    </div>
                                    <p class="text-muted small mb-0">@desc</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </Authorized>
</AuthorizeView>
