@page "/users"
@using OAuthProvider.Services
@using OAuthProvider.Models
@using Microsoft.AspNetCore.Identity
@inject IDashboardService Dashboard
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]

<PageTitle>Users â€” OAuth Provider</PageTitle>

<div class="d-flex align-items-center justify-content-between mb-4">
    <div>
        <h4 class="fw-bold mb-1">User Management</h4>
        <p class="text-muted mb-0">Manage users, roles, and access</p>
    </div>
    <button class="btn btn-primary" @onclick="() => _showCreate = !_showCreate">+ Create User</button>
</div>

@if (_showCreate)
{
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3"><h6 class="mb-0 fw-semibold">Create New User</h6></div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-medium">Email</label>
                    <input type="email" class="form-control" @bind="_newEmail" />
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-medium">First Name</label>
                    <input type="text" class="form-control" @bind="_newFirst" />
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-medium">Last Name</label>
                    <input type="text" class="form-control" @bind="_newLast" />
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-medium">Password</label>
                    <input type="password" class="form-control" @bind="_newPassword" />
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-medium">Role</label>
                    <select class="form-select" @bind="_newRole">
                        <option value="Developer">Developer</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(_createError))
            {
                <div class="alert alert-danger mt-3 mb-0">@_createError</div>
            }
        </div>
        <div class="card-footer bg-white d-flex gap-2">
            <button class="btn btn-primary" @onclick="CreateUser">Create</button>
            <button class="btn btn-secondary" @onclick="() => _showCreate = false">Cancel</button>
        </div>
    </div>
}

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        @if (_users == null)
        {
            <div class="text-center p-4"><div class="spinner-border text-primary"></div></div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="px-4">User</th>
                            <th>Roles</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in _users)
                        {
                            var roles = _userRoles.ContainsKey(user.Id) ? _userRoles[user.Id] : new List<string>();
                            var isLocked = user.LockoutEnd != null && user.LockoutEnd > DateTimeOffset.UtcNow;
                            <tr>
                                <td class="px-4">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width:32px;height:32px;font-size:13px;">
                                            @(user.Email?.Substring(0, 1).ToUpper())
                                        </div>
                                        <div>
                                            <div class="fw-medium small">@user.Email</div>
                                            <small class="text-muted">@(user.FirstName) @(user.LastName)</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @foreach (var role in roles)
                                    {
                                        <span class="badge @(role == "Admin" ? "bg-danger" : "bg-primary") bg-opacity-10 @(role == "Admin" ? "text-danger" : "text-primary") me-1">@role</span>
                                    }
                                </td>
                                <td>
                                    @if (isLocked)
                                    {
                                        <span class="badge bg-danger">Locked</span>
                                    }
                                    else if (user.IsActive)
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Inactive</span>
                                    }
                                </td>
                                <td class="text-muted small">@(user.LastLoginAt?.ToString("MMM d, HH:mm") ?? "Never")</td>
                                <td class="text-muted small">@user.CreatedAt.ToString("MMM d, yyyy")</td>
                                <td>
                                    <div class="d-flex gap-1">
                                        <a href="/users/@user.Id" class="btn btn-sm btn-outline-primary">Edit</a>
                                        @if (isLocked)
                                        {
                                            <button class="btn btn-sm btn-outline-success" @onclick="() => UnlockUser(user.Id)">Unlock</button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-outline-warning" @onclick="() => LockUser(user.Id)">Lock</button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@code {
    private List<ApplicationUser>? _users;
    private Dictionary<string, List<string>> _userRoles = new();
    private bool _showCreate = false;
    private string _newEmail = "";
    private string _newFirst = "";
    private string _newLast = "";
    private string _newPassword = "";
    private string _newRole = "Developer";
    private string? _createError;

    protected override async Task OnInitializedAsync() => await LoadUsers();

    private async Task LoadUsers()
    {
        _users = await Dashboard.GetUsersAsync();
        _userRoles = new();
        foreach (var u in _users)
            _userRoles[u.Id] = await Dashboard.GetUserRolesAsync(u.Id);
    }

    private async Task CreateUser()
    {
        if (string.IsNullOrWhiteSpace(_newEmail) || string.IsNullOrWhiteSpace(_newPassword))
        { _createError = "Email and password are required"; return; }

        var user = new ApplicationUser
        {
            UserName = _newEmail,
            Email = _newEmail,
            FirstName = _newFirst,
            LastName = _newLast,
            EmailConfirmed = true
        };
        var result = await UserManager.CreateAsync(user, _newPassword);
        if (!result.Succeeded) { _createError = string.Join(", ", result.Errors.Select(e => e.Description)); return; }
        await UserManager.AddToRoleAsync(user, _newRole);
        _showCreate = false;
        _newEmail = _newFirst = _newLast = _newPassword = "";
        _createError = null;
        await LoadUsers();
    }

    private async Task LockUser(string id) { await Dashboard.SetUserLockedAsync(id, true); await LoadUsers(); }
    private async Task UnlockUser(string id) { await Dashboard.SetUserLockedAsync(id, false); await LoadUsers(); }
}
