@page "/super/waf"
@inject ApplicationDbContext Db
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "SuperAdmin")]

<PageTitle>WAF Monitor â€” Super Admin</PageTitle>

<div class="d-flex align-items-center justify-content-between mb-4">
    <div>
        <h4 class="fw-bold">WAF Monitor</h4>
        <p class="text-muted mb-0">Web Application Firewall â€” threat detection and blocking</p>
    </div>
    <a href="/super/waf/rules" class="btn btn-primary">Manage Rules â†’</a>
</div>

<!-- Stats -->
<div class="row g-3 mb-4">
    @foreach (var (label, count, color, icon) in _threatStats)
    {
        <div class="col-sm-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center gap-3 py-3">
                    <div class="stat-icon" style="background:@color;font-size:18px;">@icon</div>
                    <div>
                        <div class="stat-value fs-4">@count</div>
                        <div class="stat-label">@label</div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Filters -->
<div class="card border-0 shadow-sm mb-3">
    <div class="card-body py-2">
        <div class="d-flex gap-3 align-items-center flex-wrap">
            <select class="form-select form-select-sm" style="width:auto;" @bind="_filterThreat" @bind:after="LoadAsync">
                <option value="">All Threats</option>
                <option value="rate_limit">Rate Limit</option>
                <option value="sql_injection">SQL Injection</option>
                <option value="xss">XSS</option>
                <option value="path_traversal">Path Traversal</option>
                <option value="suspicious_ua">Suspicious UA</option>
                <option value="ip_block">IP Block</option>
            </select>
            <select class="form-select form-select-sm" style="width:auto;" @bind="_filterLevel" @bind:after="LoadAsync">
                <option value="">All Levels</option>
                <option value="critical">Critical</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>
            <div class="ms-auto text-muted small">@_events.Count events shown</div>
        </div>
    </div>
</div>

<!-- Events table -->
<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="px-4">IP Address</th>
                        <th>Path</th>
                        <th>Threat</th>
                        <th>Level</th>
                        <th>Rule</th>
                        <th>Pattern</th>
                        <th>Time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var e in _events)
                    {
                        <tr>
                            <td class="px-4"><code class="small">@e.IpAddress</code></td>
                            <td class="small"><span class="badge bg-secondary me-1">@e.RequestMethod</span>@e.RequestPath</td>
                            <td><span class="badge bg-danger">@e.ThreatType.Replace("_"," ")</span></td>
                            <td><span class="badge @GetLevelBadge(e.ThreatLevel)">@e.ThreatLevel</span></td>
                            <td class="small text-muted">@(e.RuleName ?? "â€”")</td>
                            <td class="small text-muted text-truncate" style="max-width:120px;" title="@e.MatchedPattern">@(e.MatchedPattern ?? "â€”")</td>
                            <td class="small text-muted text-nowrap">@e.CreatedAt.ToString("MMM d HH:mm:ss")</td>
                            <td>
                                <button class="btn btn-xs btn-outline-danger"
                                        @onclick="() => BlockIpAsync(e.IpAddress)"
                                        title="Add IP block rule">Block IP</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(_successMsg))
{
    <div class="alert alert-success mt-3">@_successMsg</div>
}

@code {
    private List<WafEvent> _events = new();
    private string _filterThreat = "", _filterLevel = "", _successMsg = "";
    private List<(string label, long count, string color, string icon)> _threatStats = new();

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        var since = DateTime.UtcNow.AddHours(-24);
        var query = Db.WafEvents.Where(e => e.CreatedAt >= since);
        if (!string.IsNullOrEmpty(_filterThreat)) query = query.Where(e => e.ThreatType == _filterThreat);
        if (!string.IsNullOrEmpty(_filterLevel))  query = query.Where(e => e.ThreatLevel == _filterLevel);
        _events = await query.OrderByDescending(e => e.CreatedAt).Take(200).ToListAsync();

        // Stats per threat type
        var all = await Db.WafEvents.Where(e => e.CreatedAt >= since).ToListAsync();
        _threatStats = new()
        {
            ("Rate Limit",     all.Count(e => e.ThreatType == "rate_limit"),    "#fef9c3", "â±"),
            ("SQL Injection",  all.Count(e => e.ThreatType == "sql_injection"), "#fee2e2", "ðŸ’‰"),
            ("XSS Attempts",   all.Count(e => e.ThreatType == "xss"),           "#fce7f3", "ðŸ–Š"),
            ("Other Threats",  all.Count(e => !new[]{"rate_limit","sql_injection","xss"}.Contains(e.ThreatType)), "#ede9fe", "ðŸ›¡"),
        };
    }

    private async Task BlockIpAsync(string ip)
    {
        if (!await Db.WafRules.AnyAsync(r => r.RuleType == "ip_block" && r.Pattern == ip))
        {
            Db.WafRules.Add(new WafRule
            {
                Name      = $"Auto-block: {ip}",
                RuleType  = "ip_block",
                Pattern   = ip,
                IsEnabled = true,
                IsBlock   = true,
                Notes     = $"Auto-created from WAF event on {DateTime.UtcNow:yyyy-MM-dd}",
            });
            await Db.SaveChangesAsync();
        }
        _successMsg = $"IP {ip} has been blocked.";
        await LoadAsync();
    }

    private static string GetLevelBadge(string level) => level switch
    {
        "critical" => "bg-danger",
        "high"     => "bg-warning text-dark",
        "medium"   => "bg-info text-dark",
        _          => "bg-secondary",
    };
}
