@page "/super/waf/rules"
@inject ApplicationDbContext Db
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "SuperAdmin")]

<PageTitle>WAF Rules — Super Admin</PageTitle>

<div class="d-flex align-items-center gap-3 mb-4">
    <a href="/super/waf" class="btn btn-sm btn-outline-secondary">← WAF Monitor</a>
    <div>
        <h4 class="fw-bold mb-0">Platform WAF Rules</h4>
        <p class="text-muted mb-0 small">Global rules applied to all traffic on the platform</p>
    </div>
    <button class="btn btn-primary ms-auto" @onclick="() => _showCreate = true">+ Add Rule</button>
</div>

@if (!string.IsNullOrEmpty(_message))
{ <div class="alert alert-@(_isError ? "danger" : "success") small mb-3">@_message</div> }

@if (_showCreate)
{
    <div class="card border-0 shadow-sm border-start border-primary border-3 mb-4">
        <div class="card-body">
            <h6 class="fw-semibold mb-3">New Platform Rule</h6>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small fw-medium">Rule Type</label>
                    <select class="form-select" @bind="_ruleType">
                        <option value="ip_block">Block IP Address</option>
                        <option value="ip_allow">Allow IP (bypass WAF)</option>
                        <option value="ua_block">Block User-Agent Pattern</option>
                        <option value="path_block">Block URL Path</option>
                        <option value="geo_block">Block Country Code</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-medium">Pattern / Value</label>
                    <input class="form-control" @bind="_rulePattern" placeholder="e.g. 1.2.3.4 or sqlmap"/>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-medium">Priority (lower = first)</label>
                    <input type="number" class="form-control" @bind="_rulePriority"/>
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-medium">Name</label>
                    <input class="form-control" @bind="_ruleName"/>
                </div>
                <div class="col-12">
                    <label class="form-label small fw-medium">Notes</label>
                    <input class="form-control" @bind="_ruleNotes" placeholder="Reason for this rule"/>
                </div>
            </div>
            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-danger" @onclick="CreateRuleAsync">Add Platform Rule</button>
                <button class="btn btn-outline-secondary" @onclick="() => _showCreate = false">Cancel</button>
            </div>
        </div>
    </div>
}

<!-- Platform rules (no OrgId) -->
<h6 class="fw-semibold text-muted mb-3">PLATFORM-WIDE RULES</h6>
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="px-4">Name</th>
                        <th>Type</th>
                        <th>Pattern</th>
                        <th>Priority</th>
                        <th>Notes</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in _platformRules)
                    {
                        <tr>
                            <td class="px-4 fw-medium small">@r.Name</td>
                            <td><span class="badge @GetTypeBadge(r.RuleType)">@r.RuleType.Replace("_"," ")</span></td>
                            <td><code class="small">@r.Pattern</code></td>
                            <td class="small text-muted">@r.Priority</td>
                            <td class="small text-muted text-truncate" style="max-width:160px;">@(r.Notes ?? "—")</td>
                            <td>
                                <span class="badge @(r.IsEnabled ? "bg-success" : "bg-secondary")">
                                    @(r.IsEnabled ? "Active" : "Disabled")
                                </span>
                            </td>
                            <td class="small text-muted text-nowrap">@r.CreatedAt.ToString("MMM d, yyyy")</td>
                            <td>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-xs btn-outline-secondary"
                                            @onclick="() => ToggleRuleAsync(r.Id)">
                                        @(r.IsEnabled ? "Disable" : "Enable")
                                    </button>
                                    <button class="btn btn-xs btn-outline-danger"
                                            @onclick="() => DeleteRuleAsync(r.Id)">Del</button>
                                </div>
                            </td>
                        </tr>
                    }
                    @if (!_platformRules.Any())
                    {
                        <tr><td colspan="8" class="text-center text-muted py-4 small">No platform rules defined</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Org-specific rules (read-only view for super admin) -->
<h6 class="fw-semibold text-muted mb-3">ORGANIZATION RULES</h6>
<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="px-4">Organization</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Pattern</th>
                        <th>Status</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in _orgRules)
                    {
                        <tr>
                            <td class="px-4 small fw-medium">@(_orgNames.GetValueOrDefault(r.OrganizationId ?? 0, "Unknown"))</td>
                            <td class="small">@r.Name</td>
                            <td><span class="badge @GetTypeBadge(r.RuleType)">@r.RuleType.Replace("_"," ")</span></td>
                            <td><code class="small">@r.Pattern</code></td>
                            <td><span class="badge @(r.IsEnabled ? "bg-success" : "bg-secondary")">@(r.IsEnabled ? "Active" : "Disabled")</span></td>
                            <td class="small text-muted text-nowrap">@r.CreatedAt.ToString("MMM d, yyyy")</td>
                        </tr>
                    }
                    @if (!_orgRules.Any())
                    {
                        <tr><td colspan="6" class="text-center text-muted py-4 small">No organization-specific rules</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private List<WafRule> _platformRules = new();
    private List<WafRule> _orgRules = new();
    private Dictionary<int, string> _orgNames = new();
    private bool _showCreate;
    private string _ruleType = "ip_block", _rulePattern = "", _ruleName = "", _ruleNotes = "";
    private int _rulePriority = 100;
    private string _message = "";
    private bool _isError;

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        var allRules = await Db.WafRules.OrderBy(r => r.Priority).ThenBy(r => r.CreatedAt).ToListAsync();
        _platformRules = allRules.Where(r => r.OrganizationId == null).ToList();
        _orgRules      = allRules.Where(r => r.OrganizationId != null).ToList();

        var orgIds = _orgRules.Select(r => r.OrganizationId!.Value).Distinct().ToList();
        _orgNames  = await Db.Organizations
            .Where(o => orgIds.Contains(o.Id))
            .ToDictionaryAsync(o => o.Id, o => o.Name);
    }

    private async Task CreateRuleAsync()
    {
        if (string.IsNullOrWhiteSpace(_rulePattern) || string.IsNullOrWhiteSpace(_ruleName))
        { _message = "Name and pattern are required."; _isError = true; return; }

        Db.WafRules.Add(new WafRule
        {
            OrganizationId = null,   // platform-wide
            Name           = _ruleName,
            RuleType       = _ruleType,
            Pattern        = _rulePattern,
            Notes          = _ruleNotes,
            Priority       = _rulePriority,
            IsEnabled      = true,
            IsBlock        = _ruleType != "ip_allow",
        });
        await Db.SaveChangesAsync();
        _message = "Platform rule added."; _isError = false;
        _showCreate = false;
        _rulePattern = _ruleName = _ruleNotes = "";
        _rulePriority = 100;
        await LoadAsync();
    }

    private async Task ToggleRuleAsync(int id)
    {
        var r = await Db.WafRules.FindAsync(id);
        if (r == null) return;
        r.IsEnabled = !r.IsEnabled;
        await Db.SaveChangesAsync();
        await LoadAsync();
    }

    private async Task DeleteRuleAsync(int id)
    {
        var r = await Db.WafRules.FindAsync(id);
        if (r != null) { Db.WafRules.Remove(r); await Db.SaveChangesAsync(); }
        await LoadAsync();
    }

    private static string GetTypeBadge(string t) => t switch
    {
        "ip_block"   => "bg-danger",
        "ip_allow"   => "bg-success",
        "ua_block"   => "bg-warning text-dark",
        "path_block" => "bg-info text-dark",
        "geo_block"  => "bg-secondary",
        _            => "bg-secondary",
    };
}
