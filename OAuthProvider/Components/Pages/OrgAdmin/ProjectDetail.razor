@page "/projects/{Id:int}"
@inject ApplicationDbContext Db
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "OrgAdmin")]

<PageTitle>Project Detail — OAuth Provider</PageTitle>

@if (_project == null)
{
    <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
    return;
}

<div class="d-flex align-items-center gap-3 mb-4">
    <a href="/projects" class="btn btn-sm btn-outline-secondary">← Projects</a>
    <h4 class="fw-bold mb-0">@_project.Name</h4>
    @if (!string.IsNullOrEmpty(_project.Description))
    { <span class="text-muted small">— @_project.Description</span> }
</div>

@if (!string.IsNullOrEmpty(_message))
{ <div class="alert alert-@(_isError ? "danger" : "success") small mb-4">@_message</div> }

<div class="row g-4">
    <!-- Clients -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-semibold">OAuth Clients (@_project.Clients.Count)</h6>
                <a href="/clients/create" class="btn btn-sm btn-primary">+ Add Client</a>
            </div>
            <div class="card-body p-0">
                @if (!_project.Clients.Any())
                {
                    <div class="text-center py-4 text-muted small">No clients yet</div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr><th class="px-4">Name</th><th>Client ID</th><th>Status</th><th></th></tr>
                            </thead>
                            <tbody>
                                @foreach (var c in _project.Clients)
                                {
                                    <tr>
                                        <td class="px-4 fw-medium small">@c.Name</td>
                                        <td><code style="font-size:11px;">@c.ClientId</code></td>
                                        <td><span class="badge @(c.IsEnabled ? "bg-success" : "bg-secondary")">@(c.IsEnabled ? "Active" : "Disabled")</span></td>
                                        <td><a href="/clients/@c.Id" class="btn btn-xs btn-outline-primary">Manage</a></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Members -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3"><h6 class="mb-0 fw-semibold">Members</h6></div>
            <div class="card-body">
                @foreach (var pu in _project.ProjectUsers)
                {
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <div class="user-avatar-sm" style="width:28px;height:28px;font-size:11px;">
                            @(pu.User.FirstName?.Substring(0,1) ?? "?")
                        </div>
                        <div class="flex-grow-1 small">
                            <div class="fw-medium">@pu.User.FullName</div>
                            <div class="text-muted" style="font-size:10px;">@pu.Role</div>
                        </div>
                        <button class="btn btn-xs btn-outline-danger"
                                @onclick="() => RemoveMemberAsync(pu.UserId)">×</button>
                    </div>
                }

                <hr/>
                <h6 class="fw-semibold small mb-2">Add Member</h6>
                <select class="form-select form-select-sm mb-2" @bind="_addUserId">
                    <option value="">— Select user —</option>
                    @foreach (var u in _orgUsers.Where(u => !_project.ProjectUsers.Any(pu => pu.UserId == u.Id)))
                    {
                        <option value="@u.Id">@u.Email</option>
                    }
                </select>
                <select class="form-select form-select-sm mb-2" @bind="_addRole">
                    <option value="developer">Developer</option>
                    <option value="admin">Admin</option>
                </select>
                <button class="btn btn-sm btn-outline-primary w-100" @onclick="AddMemberAsync">Add</button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }
    private Project? _project;
    private int _orgId;
    private List<ApplicationUser> _orgUsers = new();
    private string _addUserId = "", _addRole = "developer";
    private string _message = "";
    private bool _isError;

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await Db.Users.FirstOrDefaultAsync(u => u.Email == auth.User.Identity!.Name);
        if (user?.OrganizationId == null) return;
        _orgId = user.OrganizationId.Value;
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _project = await Db.Projects
            .Include(p => p.Clients)
            .Include(p => p.ProjectUsers).ThenInclude(pu => pu.User)
            .FirstOrDefaultAsync(p => p.Id == Id && p.OrganizationId == _orgId);

        _orgUsers = await Db.OrganizationUsers
            .Where(ou => ou.OrganizationId == _orgId)
            .Include(ou => ou.User)
            .Select(ou => ou.User)
            .ToListAsync();
    }

    private async Task AddMemberAsync()
    {
        if (string.IsNullOrEmpty(_addUserId)) return;
        if (await Db.ProjectUsers.AnyAsync(pu => pu.ProjectId == Id && pu.UserId == _addUserId))
        { _message = "User is already a member."; _isError = true; return; }

        Db.ProjectUsers.Add(new ProjectUser { ProjectId = Id, UserId = _addUserId, Role = _addRole });
        await Db.SaveChangesAsync();
        _addUserId = "";
        _message = "Member added."; _isError = false;
        await LoadAsync();
    }

    private async Task RemoveMemberAsync(string userId)
    {
        var pu = await Db.ProjectUsers.FirstOrDefaultAsync(p => p.ProjectId == Id && p.UserId == userId);
        if (pu != null) { Db.ProjectUsers.Remove(pu); await Db.SaveChangesAsync(); }
        await LoadAsync();
    }
}
